/*
 *  jQuery WQueryBuilder - v0.1.0
 *  jQuery Plugin to create sql queries an easy way
 *  
 *
 *  Made by Webbers
 *  Under MIT License
 */
!function($,window,document,undefined){function Plugin(a,b){return _.isString(b)?void this.methods[b](this,a,b):(this.element=a,this.DataTypes={TABLE:{value:"table"},COLUMN:{value:"column"},LIMIT:{value:"limit"},ORDERBY:{value:"orderby"},UNKNOW:{value:"unknow"},GROUPBY:{value:"group"},SPARECOLUMN:{value:"field"}},this.AggregateFunctions={DAY:{value:"DAY"},MONTH:{value:"MONTH"},YEAR:{value:"YEAR"},FORMAT:{value:"FORMAT"}},this.options=$.extend({},defaults,b),this._defaults=defaults,this._name=pluginName,void this.init())}var pluginName="wquerybuilder",defaults={data:{}},wquery={from:[],field:[],spares:[],distintic:{},join:{},left_join:{},right_join:{},group:"",order:"",limit:0,where:{}},$selectboxTables,$selectboxTableColumns,$textareaQueryResult,$selectboxOptionsTag,$inputTextTop,$selectboxOrderby,$optionOrderbyType,$optionGroupbyType,$buttonCreateSpare,$inputTextSpare,$optionAggregate,$selectSpareColumnContent;Plugin.prototype={init:function(){if($selectboxTables=$(this.element).find("[name='wtables']"),$selectboxTableColumns=$(this.element).find("[name='wcolumns']"),$selectboxOrderby=$(this.element).find("[name='worderby']"),$optionOrderbyType=$(this.element).find("[name='worderbytype']"),$optionAggregate=$(this.element).find("[name='waggregate']"),$optionGroupbyType=$(this.element).find("[name='wgroupby']"),$textareaQueryResult=$(this.element).find("[name='wresult']"),$selectSpareColumnContent=$(this.element).find("[name='wcolumncontent']"),$selectboxOptionsTag=$(this.element).find("[name='worderby'],[name='wgroupby'],[name='wcolumncontent'],[name='wcolumnunion']"),$inputTextTop=$(this.element).find("[name='wtop']"),$buttonCreateSpare=$(this.element).find("[name='wcreatespare']"),$inputTextSpare=$(this.element).find("[name='wsparename']"),this.options.data)try{this.initTables(this.options.data),this.initListeners(this.options.data)}catch(a){alert("Error on initialize plugin")}},initTables:function(a){var b="";for(var c in a)b+="<option value='"+c+"'>"+c+"</option>";$selectboxTables.html(b)},initListeners:function(a){var b=this;$selectboxTables.on("change",function(){var c=$(this).val();b._executeQuery(b.DataTypes.TABLE,c),b._renderColumnsOptions(a,c)}),$selectboxTableColumns.on("change",function(){var c=$(this).val(),d=[];$.each($(this).find("option"),function(){$(this).prop("selected")||d.push($(this).val()),d.push()}),b._executeQuery(b.DataTypes.COLUMN,c,d),b._renderOptions(a,c)}),$selectboxOrderby.on("change",function(){var a=$(this).val();b._executeQuery(b.DataTypes.ORDERBY,a)}),$optionGroupbyType.on("change",function(){var a=$(this).val();b._executeQuery(b.DataTypes.GROUPBY,a)}),$optionOrderbyType.on("change",function(){if(""!==$selectboxOrderby.val()&&null!==$selectboxOrderby.val()){var a=$selectboxOrderby.val();b._executeQuery(b.DataTypes.ORDERBY,a)}}),$inputTextTop.on("blur",function(){var a=parseInt($(this).val(),10)||0;b._executeQuery(b.DataTypes.LIMIT,a)}),$buttonCreateSpare.on("click",function(){if(!_.isEmpty($selectSpareColumnContent.val())&&!_.isEmpty($inputTextSpare.val())){var a={name:_.isEmpty($inputTextSpare.val())?$selectSpareColumnContent.val():$inputTextSpare.val(),aggregate:$optionAggregate.val(),content:$selectSpareColumnContent.val()};b._executeQuery(b.DataTypes.SPARECOLUMN,a),b._cleanSpare()}})},_renderColumnsOptions:function(a,b){var c="";for(var d in a[b]){for(var e="",f=0;f<wquery.field.length;f++)if(wquery.field[f].indexOf(b+"."+a[b][d])>-1){e="selected='selected'";break}var g=b+"."+a[b][d];c+="<option "+e+" value='"+g+"'>"+a[b][d]+"</option>"}$selectboxTableColumns.html(c)},_renderOptions:function(a,b){if(null===b)return void this._cleanOptions();for(var c="<option></option>",d=0;d<wquery.from.length;d++)for(var e=wquery.from[d],f="",g=0;g<a[e].length;g++){var h=e+"."+a[e][g];$selectboxOptionsTag.val()===h&&(f="selected='selected'"),c+="<option value='"+h+"' "+f+">"+h+"</option>"}$selectboxOptionsTag.html(c)},_cleanSpare:function(){$inputTextSpare.val(""),$optionAggregate.find("option[selected]").removeAttr("selected"),$optionAggregate.find("option:eq(0)").attr("selected","selected"),$selectSpareColumnContent.find("option[selected]").removeAttr("selected"),$selectSpareColumnContent.find("option:eq(0)").attr("selected","selected")},_cleanOptions:function(){$selectboxOptionsTag.html("")},_executeQuery:function(type,val,unval){var str="";switch(type){case this.DataTypes.TABLE:wquery.from.length<=1&&0===wquery.field.length&&(wquery.from=[],wquery.from.push(val));break;case this.DataTypes.COLUMN:if(null===val&&0===wquery.from.length){wquery.from=[],wquery.from.push($selectboxTables.val()),wquery.field=[];break}if(null===val&&(wquery.from=_.difference(wquery.from,$selectboxTables.val()),0===wquery.from.length)){wquery.from.push($selectboxTables.val()),wquery.field=[];break}_.findWhere(wquery.from,$selectboxTables.val())===undefined&&null!==val&&(wquery.from=_.union(wquery.from,$selectboxTables.val())),wquery.field=_.union(wquery.field,val),wquery.field=_.difference(wquery.field,unval),wquery.field=_.compact(wquery.field);break;case this.DataTypes.LIMIT:wquery.limit=val;break;case this.DataTypes.ORDERBY:if(""===val){wquery.order=null;break}wquery.order=val+","+$optionOrderbyType.filter(function(){return $(this).is(":checked")}).val();break;case this.DataTypes.GROUPBY:wquery.group=val;break;case this.DataTypes.SPARECOLUMN:var flatVal=val.content;_.isEmpty(val.aggregate)||(flatVal=val.aggregate.toUpperCase()+"("+val.content+")"),str+=".field('"+flatVal+"','"+val.name+"')",wquery.field.push(val.content);break;default:wquery.from.push(val)}for(var clause in wquery)if($.isArray(wquery[clause])||"number"===$.type(wquery[clause])||"string"===$.type(wquery[clause]))if(!_.isEmpty(wquery[clause])&&_.isArray(wquery[clause]))for(var i=0;i<wquery[clause].length;i++){var v=_.isBoolean(wquery[clause][i])?wquery[clause][i]:"'"+wquery[clause][i]+"'";str+="."+clause+"("+v+")"}else if(_.isString(wquery[clause])){var splited=wquery[clause].split(","),l=splited.length;if(l>1){for(var z="",j=0;l>j;j++){if("true"===splited[j].toLowerCase()||"false"===splited[j].toLowerCase())z+=splited[j];else{if(null===splited[j]||splited[j]===undefined)continue;z+="'"+splited[j]+"'"}j+1!==l&&(z+=",")}str+="."+clause+"("+z+")"}else _.isEmpty(wquery[clause])||(str+="."+clause+"('"+wquery[clause]+"')")}else _.isNumber(wquery[clause])&&(str+="."+clause+"('"+wquery[clause]+"')");$textareaQueryResult.val(eval("squel.select()"+str))},methods:{clean:function(a,b){$selectboxTableColumns.html(""),$(b).find(":input").not(":button, :submit, :reset, :hidden, [type='radio']").val("").removeAttr("selected"),$(b).find("#wasc").attr("checked","checked"),$(b).find("#wdesc").removeAttr("checked"),wquery={},wquery={from:[],field:[],distintic:{},join:{},left_join:{},right_join:{},group:{},order:null,limit:0,where:{}}}}},$.fn[pluginName]=function(a){return this.each(function(){$.data(this,"plugin_"+pluginName)||_.isString(a)?$.data(this,"plugin_"+pluginName)&&_.isString(a)&&new Plugin(this,a):$.data(this,"plugin_"+pluginName,new Plugin(this,a))})}}(jQuery,window,document);