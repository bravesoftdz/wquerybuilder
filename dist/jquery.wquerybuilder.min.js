/*
 *  jQuery WQueryBuilder - v0.1.0
 *  jQuery Plugin to create sql queries an easy way
 *  
 *
 *  Made by Webbers
 *  Under MIT License
 */
!function($,window,document,undefined){function Plugin(a,b){return _.isString(b)?void this.methods[b](this,a,b):(this.element=a,this.DataTypes={TABLE:{value:"table"},COLUMN:{value:"column"},LIMIT:{value:"limit"},ORDERBY:{value:"orderby"},UNKNOW:{value:"unknow"},GROUPBY:{value:"group"},SPARECOLUMN:{value:"field"},UNION:{value:"union"},WHERE:{value:"where"}},this.AggregateFunctions={DAY:{value:"DAY"},MONTH:{value:"MONTH"},YEAR:{value:"YEAR"},FORMAT:{value:"FORMAT"},COUNT:{value:"COUNT"},SUM:{value:"SUM"},AVERAGE:{value:"AVERAGE"}},this.options=$.extend({},defaults,b),this._defaults=defaults,this._name=pluginName,void this.init())}var pluginName="wquerybuilder",defaults={data:{},sqlType:"MYSQL"},wquery={from:[],field:[],spare:[],union:[],where:[],group:"",order:"",limit:""},sqlType="",$selectboxTables,$selectboxTableColumns,$textareaQueryResult,$selectboxOptionsTag,$inputTextTop,$selectboxOrderby,$optionOrderbyType,$optionGroupbyType,$buttonCreateSpare,$buttonClearAll,$inputTextSpare,$optionAggregate,$selectSpareColumnContent,$selectboxSpares,$buttonDeleteSpare,$buttonDeleteAllSpare,$optionUnionFirst,$optionUnionSecond,$buttonCreateUnion,$buttonDeleteAllUnion,$optionFilter,$optionOperator,$inputValueFilter,$buttonCreateFilter,$buttonDeleteAllFilter,$buttonSetTop;Plugin.prototype={init:function(){if($selectboxTables=$(this.element).find("[name='wtables']"),$selectboxTableColumns=$(this.element).find("[name='wcolumns']"),$inputTextTop=$(this.element).find("[name='wtop']"),$buttonSetTop=$(this.element).find("[name='wsettop']"),$selectboxOrderby=$(this.element).find("[name='worderby']"),$optionOrderbyType=$(this.element).find("[name='worderbytype']"),$optionGroupbyType=$(this.element).find("[name='wgroupby']"),$inputTextSpare=$(this.element).find("[name='wsparename']"),$optionAggregate=$(this.element).find("[name='waggregate']"),$selectSpareColumnContent=$(this.element).find("[name='wcolumncontent']"),$buttonCreateSpare=$(this.element).find("[name='wcreatespare']"),$selectboxSpares=$(this.element).find("[name='wspares']"),$buttonDeleteSpare=$(this.element).find("[name='wdeletespare']"),$buttonDeleteAllSpare=$(this.element).find("[name='wdeleteallspare']"),$optionUnionFirst=$(this.element).find("[name='wfirstcolumnunion']"),$optionUnionSecond=$(this.element).find("[name='wsecondcolumnunion']"),$buttonCreateUnion=$(this.element).find("[name='wcreateunion']"),$buttonDeleteAllUnion=$(this.element).find("[name='wdeleteallunion']"),$optionFilter=$(this.element).find("[name='wcolumnfilter']"),$optionOperator=$(this.element).find("[name='woperator']"),$inputValueFilter=$(this.element).find("[name='wvaluefilter']"),$buttonCreateFilter=$(this.element).find("[name='wcreatefilter']"),$buttonDeleteAllFilter=$(this.element).find("[name='wdeletefilter']"),$selectboxOptionsTag=$(this.element).find("[name='worderby'],[name='wgroupby'],[name='wcolumncontent'],[name='wfirstcolumnunion'],[name='wsecondcolumnunion'],[name='wcolumnfilter']"),$buttonClearAll=$(this.element).find("[name='wclearall']"),$textareaQueryResult=$(this.element).find("[name='wresult']"),this.options.data)try{sqlType=this.options.sqlType,this.initTables(this.options.data),this.initListeners(this.options.data,this.element)}catch(a){alert("Error on initialize plugin")}},initTables:function(a){var b="";for(var c in a)b+="<option value='"+c+"'>"+c+"</option>";$selectboxTables.html(b)},initListeners:function(a,b){var c=this;$selectboxTables.on("change",function(){var b=$(this).val();c._executeQuery(c.DataTypes.TABLE,b),c._renderColumnsOptions(a,b),c._renderOptions(a,b),c._renderFirstUnionOptions(a,b)}),$selectboxTableColumns.on("change",function(){var b=$(this).val(),d=[];$.each($(this).find("option"),function(){$(this).prop("selected")||d.push($(this).val())}),c._executeQuery(c.DataTypes.COLUMN,b,d),c._renderOptions(a,b)}),$buttonSetTop.on("click",function(){var a=parseInt($inputTextTop.val(),10)||0;c._executeQuery(c.DataTypes.LIMIT,a)}),$inputTextTop.on("blur",function(){var a=parseInt($(this).val(),10)||0;c._executeQuery(c.DataTypes.LIMIT,a)}),$selectboxOrderby.on("change",function(){var a=$(this).val();c._executeQuery(c.DataTypes.ORDERBY,a)}),$optionGroupbyType.on("change",function(){var a=$(this).val();c._executeQuery(c.DataTypes.GROUPBY,a)}),$optionOrderbyType.on("change",function(){if(""!==$selectboxOrderby.val()&&null!==$selectboxOrderby.val()){var a=$selectboxOrderby.val();c._executeQuery(c.DataTypes.ORDERBY,a)}}),$buttonCreateSpare.on("click",function(){if(!_.isEmpty($selectSpareColumnContent.val())&&!_.isEmpty($inputTextSpare.val())){var a={name:$inputTextSpare.val(),content:$selectSpareColumnContent.val(),aggregate:$optionAggregate.val(),format:$optionAggregate.find("option:selected").attr("data-format")};c._executeQuery(c.DataTypes.SPARECOLUMN,a),c._renderOptionsSpares(),c._cleanSpare()}}),$buttonDeleteSpare.on("click",function(){var a=[];$.each($selectboxSpares.find("option"),function(){$(this).prop("selected")&&(a.push($(this).val()),$(this).remove())});for(var b=0;b<a.length;b++)for(var d=0;d<wquery.spare.length;d++){var e=wquery.spare[d].content+"-"+wquery.spare[d].name;a[b]===e&&wquery.spare.splice(wquery.spare.indexOf(wquery.spare[d]),1)}c._executeQuery(c.DataTypes.SPARECOLUMN,"")}),$buttonDeleteAllSpare.on("click",function(){$selectboxSpares.html(""),wquery.spare=[],c._executeQuery(c.DataTypes.SPARECOLUMN,"")}),$buttonCreateUnion.on("click",function(){_.isEmpty($optionUnionFirst.val())||_.isEmpty($optionUnionSecond.val())}),$buttonDeleteAllUnion.on("click",function(){}),$buttonCreateFilter.on("click",function(){if(!_.isEmpty($optionFilter.val())&&!_.isEmpty($optionOperator.val())&&""!==$inputValueFilter.val()){var a={column:$optionFilter.val(),operator:$optionOperator.val(),value:$inputValueFilter.val()};c._executeQuery(c.DataTypes.WHERE,a),$optionFilter.val(""),$optionOperator.find("option:eq(0)").attr("selected","selected"),$inputValueFilter.val("")}}),$buttonDeleteAllFilter.on("click",function(){wquery.where=[],c._executeQuery(c.DataTypes.WHERE,"")}),$buttonClearAll.on("click",function(){c.methods.clean(b)})},_renderColumnsOptions:function(a,b){var c="";for(var d in a[b]){for(var e="",f=0;f<wquery.field.length;f++)if(wquery.field[f].indexOf(b+"."+a[b][d])>-1){e="selected='selected'";break}var g=b+"."+a[b][d];c+="<option "+e+" value='"+g+"'>"+a[b][d]+"</option>"}$selectboxTableColumns.html(c)},_renderOptions:function(a,b){if(null===b)return void this._cleanOptions();for(var c="<option></option>",d=0;d<wquery.from.length;d++)for(var e=wquery.from[d],f="",g=0;g<a[e].length;g++){var h=e+"."+a[e][g];$selectboxOptionsTag.val()===h&&(f="selected='selected'"),c+="<option value='"+h+"' "+f+">"+h+"</option>"}$selectboxOptionsTag.html(c)},_renderOptionsSpares:function(){for(var a="",b=0;b<wquery.spare.length;b++)a+="<option value='"+wquery.spare[b].content+"-"+wquery.spare[b].name+"'>"+wquery.spare[b].content+" ( "+wquery.spare[b].name+" )</option>";$selectboxSpares.html(a)},_renderFirstUnionOptions:function(a,b){var c="<option></option>";for(var d in a[b]){var e=b+"."+a[b][d];c+="<option value='"+e+"'>"+e+"</option>"}$optionUnionFirst.html(c)},_cleanSpare:function(){$inputTextSpare.val(""),$optionAggregate.find("option:selected").removeAttr("selected"),$optionAggregate.find("option:eq(0)").attr("selected","selected"),$selectSpareColumnContent.find("option:selected").removeAttr("selected"),$selectSpareColumnContent.find("option:eq(0)").attr("selected","selected")},_cleanOptions:function(){$selectboxOptionsTag.html("")},_executeQuery:function(type,val,unval){var str="";switch(type){case this.DataTypes.TABLE:wquery.from.length<=1&&0===wquery.field.length&&(wquery.from=[],wquery.from.push(val));break;case this.DataTypes.COLUMN:if(null===val&&0===wquery.from.length){wquery.from=[],wquery.from.push($selectboxTables.val()),wquery.field=[];break}if(null===val&&(wquery.from=_.difference(wquery.from,$selectboxTables.val()),0===wquery.from.length)){wquery.from.push($selectboxTables.val()),wquery.field=[];break}_.findWhere(wquery.from,$selectboxTables.val())===undefined&&null!==val&&(wquery.from=_.union(wquery.from,$selectboxTables.val())),wquery.field=_.union(wquery.field,val),wquery.field=_.difference(wquery.field,unval),wquery.field=_.compact(wquery.field);break;case this.DataTypes.LIMIT:wquery.limit=val;break;case this.DataTypes.ORDERBY:if(""===val){wquery.order=null;break}wquery.order=val+","+$optionOrderbyType.filter(function(){return $(this).is(":checked")}).val();break;case this.DataTypes.GROUPBY:wquery.group=val;break;case this.DataTypes.SPARECOLUMN:_.isEmpty(val)||(wquery.spare=_.union(wquery.spare,val));break;case this.DataTypes.UNION:_.isEmpty(val)||(wquery.union=_.union(wquery.union,val));break;case this.DataTypes.WHERE:_.isEmpty(val)||(wquery.where=_.union(wquery.where,val));break;default:wquery.from.push(val)}var froms=wquery.from;for(var from in froms)_.isEmpty(froms[from])||(str+=".from('"+froms[from]+"')");var fields=wquery.field;for(var field in fields)_.isEmpty(fields[field])||(str+=".field('"+fields[field]+"')");for(var spares=wquery.spare,i=0;i<spares.length;i++)str+=_.isEmpty(spares[i].aggregate)?".field('"+spares[i].content+"', '"+spares[i].name+"')":_.isEmpty(spares[i].format)?".field('"+spares[i].aggregate+"("+spares[i].content+")', '"+spares[i].name+"')":'.field("'+spares[i].aggregate+"("+spares[i].content+", '"+spares[i].format+"')\", '"+spares[i].name+"')";var order=wquery.order;_.isEmpty(order)||(str+=".order('"+order.split(",")[0]+"',"+order.split(",")[1]+")");var group=wquery.group;_.isEmpty(group)||(str+=".group('"+group+"')");for(var unions=wquery.union,j=0;j<unions.length;j++)str+=".from('"+unions[j].firstTable+"')",str+=".join('"+unions[j].secondTable+"', null, '"+unions[j].firstColumn+" = "+unions[j].secondColumn+"')";for(var filters=wquery.where,k=0;k<filters.length;k++){var value=parseInt(filters[k].value,10)||'"'+filters[k].value+'"';str+=".where('"+filters[k].column+" "+filters[k].operator+" "+value+"')"}var result="";if(""===wquery.limit)result=eval("squel.select()"+str);else if("MSSQL"===sqlType){var top="SELECT TOP "+wquery.limit;result=eval("squel.select()"+str).toString(),result=result.replace("SELECT",top)}else"ORACLE"===sqlType?(str+=".where('ROWNUM <= "+wquery.limit+"')",result=eval("squel.select()"+str)):"MYSQL"===sqlType&&(str+=".limit("+wquery.limit+")",result=eval("squel.select()"+str));$textareaQueryResult.val(result)},methods:{clean:function(a){$selectboxTableColumns.html(""),$selectboxSpares.html(""),$selectboxOptionsTag.html(""),$optionUnionSecond.html(""),$(a).find("input, textarea, select").not("[type='button'], [type='submit'], [type='reset'], [type='hidden'], [type='radio']").val("").removeAttr("selected"),$(a).find("#wasc").attr("checked","checked"),$(a).find("#wdesc").removeAttr("checked"),wquery={},wquery={from:[],field:[],spare:[],union:[],where:[],group:"",order:"",limit:""}},mysql:function(){sqlType="MYSQL"},mssql:function(){sqlType="MSSQL"},oracle:function(){sqlType="ORACLE"}}},$.fn[pluginName]=function(a){return this.each(function(){$.data(this,"plugin_"+pluginName)||_.isString(a)?$.data(this,"plugin_"+pluginName)&&_.isString(a)&&new Plugin(this,a):$.data(this,"plugin_"+pluginName,new Plugin(this,a))})}}(jQuery,window,document);