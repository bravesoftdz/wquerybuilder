/*
 *  jQuery WQueryBuilder - v0.1.0
 *  jQuery Plugin to create sql queries an easy way
 *  
 *
 *  Made by Webbers
 *  Under MIT License
 */
!function($,window,document,undefined){function Plugin(a,b){this.element=a,this.DataTypes={TABLE:{value:"table"},COLUMN:{value:"column"},LIMIT:{value:"limit"},ORDERBY:{value:"orderby"}},this.options=$.extend({},defaults,b),this._defaults=defaults,this._name=pluginName,this.init()}var pluginName="wquerybuilder",defaults={data:{}},$selectboxTables,$selectboxTableColumns,$textareaQueryResult,$selectboxOptionsTag,$inputTextTop,$selectboxOrderby,wquery={from:[],field:[],distintic:{},join:{},left_join:{},right_join:{},group:{},order:null,limit:0,where:{}};Plugin.prototype={init:function(){if($selectboxTables=$(this.element).find("[name='wtables']"),$selectboxTableColumns=$(this.element).find("[name='wcolumns']"),$selectboxOrderby=$(this.element).find("[name='worderby']"),$textareaQueryResult=$(this.element).find("[name='wresult']"),$selectboxOptionsTag=$(this.element).find("[name='worderby'],[name='wgroupby'],[name='wcolumncontent'],[name='wcolumnunion']"),$inputTextTop=$(this.element).find("[name='wtop']"),this.options.data)try{this.initTables(this.options.data),this.initListeners(this.options.data)}catch(a){alert("Error on initialize plugin")}},initTables:function(a){var b="";for(var c in a)b+="<option value='"+c+"'>"+c+"</option>";$selectboxTables.html(b)},initListeners:function(a){var b=this;$selectboxTables.on("change",function(){var c=$(this).val();b.executeQuery(b.DataTypes.TABLE,c),b.renderColumnsOptions(a,c)}),$selectboxTableColumns.on("change",function(){var c=$(this).val(),d=[];$.each($(this).find("option"),function(){$(this).prop("selected")||d.push($(this).val()),d.push()}),b.executeQuery(b.DataTypes.COLUMN,c,d),b.renderOptions(a,c)}),$selectboxOrderby.on("change",function(){var a=$(this).val();b.executeQuery(b.DataTypes.ORDERBY,a)}),$inputTextTop.on("blur",function(){var a=parseInt($(this).val(),10)||0;b.executeQuery(b.DataTypes.LIMIT,a)})},renderColumnsOptions:function(a,b){var c="";for(var d in a[b]){for(var e="",f=0;f<wquery.field.length;f++)if(wquery.field[f].indexOf(b+"."+a[b][d])>-1){e="selected='selected'";break}var g=b+"."+a[b][d];c+="<option "+e+" value='"+g+"'>"+a[b][d]+"</option>"}$selectboxTableColumns.html(c)},renderOptions:function(a){for(var b="<option></option>",c=0;c<wquery.from.length;c++)for(var d=wquery.from[c],e=0;e<a[d].length;e++){var f=d+"."+a[d][e];b+="<option value='"+f+"'>"+f+"</option>"}$selectboxOptionsTag.html(b)},executeQuery:function(type,val,unval){var str="";switch(type){case this.DataTypes.TABLE:wquery.from.length<=1&&0===wquery.field.length&&(wquery.from=[],wquery.from.push(val));break;case this.DataTypes.COLUMN:if(null===val&&0===wquery.from.length){wquery.from=[],wquery.from.push($selectboxTables.val()),wquery.field=[];break}if(null===val&&(wquery.from=_.difference(wquery.from,$selectboxTables.val()),0===wquery.from.length)){wquery.from.push($selectboxTables.val()),wquery.field=[];break}_.findWhere(wquery.from,$selectboxTables.val())===undefined&&null!==val&&(wquery.from=_.union(wquery.from,$selectboxTables.val())),wquery.field=_.union(wquery.field,val),wquery.field=_.difference(wquery.field,unval),wquery.field=_.compact(wquery.field);break;case this.DataTypes.LIMIT:wquery.limit=val;break;case this.DataTypes.ORDERBY:wquery.order=val}for(var clause in wquery)($.isArray(wquery[clause])||"number"===$.type(wquery[clause])||"string"===$.type(wquery[clause]))&&(!_.isEmpty(wquery[clause])&&_.isArray(wquery[clause])?str+="."+clause+"('"+_.compact(wquery[clause])+"')":(_.isNumber(wquery[clause])||_.isString(wquery[clause]))&&(str+="."+clause+"('"+wquery[clause]+"')"));$textareaQueryResult.val(eval("squel.select()"+str))}},$.fn[pluginName]=function(a){return this.each(function(){$.data(this,"plugin_"+pluginName)||$.data(this,"plugin_"+pluginName,new Plugin(this,a))})}}(jQuery,window,document);